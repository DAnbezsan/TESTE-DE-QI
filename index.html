<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Cpath fill='%2360A5FA' d='M25.9 10.1C25.4 6.7 22.8 4 19.5 4c-1.8 0-3.4.8-4.6 2c-1.1-.4-2.3-.6-3.5-.6c-4.1 0-7.5 3.4-7.5 7.5c0 2.1.9 4.1 2.3 5.5C6.1 20 6 21.5 6 22.9C6 26.8 9.2 30 13.1 30c2.8 0 5.2-1.6 6.4-4h.2c.4-1.2.6-2.4.6-3.7c0-2.4-1.2-4.5-3-5.8c.4-.6.6-1.3.6-2c0-1.8-1.2-3.3-2.9-3.9c.7-1.3 2-2.1 3.5-2.1c2.2 0 4.1 1.6 4.5 3.7c1.1.2 2 .8 2.5 1.7c.6-1.1 1-2.4 1-3.8c0-.6-.1-1.2-.2-1.8z'/%3E%3C/svg%3E">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teste de QI para Concurso</title>
  <meta name="description" content="Avalie suas habilidades de raciocínio lógico, verbal e matemático com este teste de QI preparatório para concursos federais e estaduais." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-gray-900 text-white">
  <noscript>
    <div style="background-color: #111827; color: white; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-family: sans-serif; padding: 20px;">
      <h1 style="font-size: 2rem; margin-bottom: 1rem;">JavaScript é necessário</h1>
      <p style="font-size: 1.2rem;">Este aplicativo requer JavaScript para funcionar. Por favor, habilite o JavaScript em seu navegador e atualize a página.</p>
    </div>
  </noscript>
  <div id="root"></div>
  <script type="module">
    // --- Bundled Application ---
    import React, { useState, useEffect, useCallback } from 'react';
    import ReactDOM from 'react-dom/client';
    import { GoogleGenAI, Type } from "@google/genai";

    // --- CHAVES DE ACESSO - ADICIONE AQUI ---
    // ADVERTÊNCIA: Adicionar chaves diretamente no código não é seguro.
    // Qualquer pessoa poderá ver suas chaves. Use variáveis de ambiente se possível.
    
    // 1. Cole sua chave da API do Google Gemini aqui:
    const API_KEY = "cliente-gen-lang-0847844233"; 
    
    // 2. Chaves do JSONBin.io (JÁ ADICIONADAS):
    const JSONBIN_API_KEY = "$2a$10$RxtN.VwYLRsGcmoCji08oeL2di9W0D4tyrBZe/vIV77N665ALQ9Vi";
    const JSONBIN_BIN_ID = "6919f637d0ea881f40ec3f67";

    // --- Verificação de Configuração ---
    if (API_KEY === "cliente-gen-lang-0847844233") {
        const rootDiv = document.getElementById('root');
        if(rootDiv) {
            rootDiv.innerHTML = `<div style="color: red; padding: 20px; text-align: center;">CONFIGURAÇÃO NECESSÁRIA: Por favor, adicione sua API_KEY do Google Gemini no local indicado dentro do arquivo index.html.</div>`;
        }
    } else {
        // --- Enums and Types ---
        const GameState = Object.freeze({
            Loading: 'Loading',
            Welcome: 'Welcome',
            Registration: 'Registration',
            InProgress: 'InProgress',
            Payment: 'Payment',
            PixPayment: 'PixPayment',
            Results: 'Results',
            Error: 'Error',
        });

        // --- Gemini API Service ---
        const ai = new GoogleGenAI({ apiKey: API_KEY });
        const questionSchema = {
            type: Type.OBJECT,
            properties: {
                question: { type: Type.STRING, description: "O texto da pergunta." },
                options: { type: Type.ARRAY, items: { type: Type.STRING }, description: "Uma lista de 4 opções de resposta." },
                correctAnswerIndex: { type: Type.INTEGER, description: "O índice (0 a 3) da resposta correta na lista de opções." }
            },
            required: ["question", "options", "correctAnswerIndex"]
        };

        const generateIQTest = async () => {
            try {
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: "Gere um teste de QI com 35 perguntas em português do Brasil. As perguntas devem cobrir uma variedade de tópicos, incluindo lógica, reconhecimento de padrões, raciocínio espacial, habilidade verbal e problemas matemáticos. Cada pergunta deve ter 4 opções de múltipla escolha e uma resposta correta claramente identificada. Todo o texto gerado (perguntas e opções) deve estar em português do Brasil.",
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: { type: Type.ARRAY, items: questionSchema },
                    },
                });
                const jsonStr = response.text.trim();
                const questions = JSON.parse(jsonStr);
                if (!Array.isArray(questions) || questions.length === 0) { // Allow flexible number of questions
                    throw new Error("A API não retornou uma lista de perguntas válida.");
                }
                return questions;
            } catch (error) {
                console.error("Erro ao gerar teste de QI:", error);
                throw new Error("Não foi possível gerar as perguntas do teste. Tente novamente mais tarde.");
            }
        };

        const interpretScore = async (score, totalQuestions) => {
            try {
                const prompt = `Um usuário completou um teste de QI e acertou ${score} de ${totalQuestions} perguntas. Forneça uma interpretação breve e encorajadora deste resultado em português do Brasil. Não estime um número de QI, apenas comente sobre o desempenho de forma positiva e geral.`;
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: prompt,
                });
                return response.text;
            } catch (error) {
                console.error("Erro ao interpretar a pontuação:", error);
                return "Não foi possível interpretar sua pontuação, mas parabéns por concluir o teste!";
            }
        };

        // --- Bin Database Service ---
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        const readBin = async () => {
            try {
                const response = await fetch(`${JSONBIN_URL}/latest`, {
                    method: 'GET',
                    headers: { 'X-Master-Key': JSONBIN_API_KEY }
                });
                if (!response.ok) {
                    if (response.status === 404) return {}; // Bin is empty or doesn't exist yet, return empty object
                    throw new Error(`Erro ao ler o bin: ${response.statusText}`);
                }
                const data = await response.json();
                return data.record || {};
            } catch (error) {
                console.error("Erro ao ler do bin:", error);
                throw new Error("Não foi possível conectar ao banco de dados de usuários.");
            }
        };

        const updateBin = async (data) => {
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error(`Erro ao atualizar o bin: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error("Erro ao atualizar o bin:", error);
                throw new Error("Não foi possível salvar os dados do usuário.");
            }
        };

        // --- Components ---
        const LoadingSpinner = ({ message }) => (
            React.createElement('div', { className: "flex flex-col items-center justify-center h-screen bg-gray-900 text-white" },
                React.createElement('div', { className: "w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-500" }),
                React.createElement('p', { className: "mt-4 text-lg text-gray-300" }, message)
            )
        );
        const BrainIcon = () => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-16 w-16 mb-4 text-blue-400", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M4.871 14.821c-1.333-1.428-2.121-3.236-2.121-5.132C2.75 6.22 5.47 3.5 8.938 3.5c2.133 0 4.013.91 5.305 2.378M19.129 14.821c1.333-1.428 2.121-3.236 2.121-5.132C21.25 6.22 18.53 3.5 15.062 3.5c-2.133 0-4.013.91-5.305 2.378m-4.552 14.622c-1.333 1.428-2.121 3.236-2.121 5.132C2.75 27.78 5.47 30.5 8.938 30.5c2.133 0 4.013-.91 5.305-2.378M9.625 10.125a.875.875 0 10-1.75 0 .875.875 0 001.75 0z", transform: "translate(0 -8)" }),
                React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M12 21.5c-1.8 0-3.465-.96-4.552-2.5m9.104 0c-1.087 1.54-2.752 2.5-4.552 2.5M13.875 10.125a.875.875 0 10-1.75 0 .875.875 0 001.75 0z", transform: "translate(0 -8)" }),
                React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M11.999 3.5c-3.468 0-6.188 2.72-6.188 6.188 0 1.896.788 3.704 2.121 5.132m8.134 0c1.333-1.428 2.121-3.236 2.121-5.132 0-3.468-2.72-6.188-6.188-6.188", transform: "translate(0 -8)" })
            )
        );
        const WelcomeScreen = ({ onStart }) => (
            React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen p-4 text-center" },
                React.createElement('div', { className: "bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-700" },
                    React.createElement(BrainIcon),
                    React.createElement('h1', { className: "text-4xl md:text-5xl font-bold text-white mb-4" }, "Teste de QI para concurso"),
                    React.createElement('p', { className: "text-lg text-gray-300 mb-8" }, "Bem-vindo! Este teste consiste em avaliar suas habilidades de raciocínio lógico, verbal e matemático para concursos federais e estaduais. Não há limite de tempo. Pense com calma e escolha a melhor resposta. Boa sorte!"),
                    React.createElement('button', { onClick: onStart, className: "w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-12 rounded-lg text-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50" }, "Começar o Teste")
                )
            )
        );
        const ProgressBar = ({ current, total }) => {
            const percentage = (current / total) * 100;
            return React.createElement('div', { className: "w-full bg-gray-700 rounded-full h-4 mb-4" },
                React.createElement('div', { className: "bg-blue-500 h-4 rounded-full transition-all duration-300 ease-in-out", style: { width: `${percentage}%` } })
            );
        };
        const QuestionCard = ({ question, questionNumber, totalQuestions, selectedAnswer, onAnswerSelect, onNext, onPrevious }) => {
            const isLastQuestion = questionNumber === totalQuestions;
            return React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen p-4" },
                React.createElement('div', { className: "bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-3xl border border-gray-700" },
                    React.createElement('div', { className: "mb-6" },
                        React.createElement('p', { className: "text-blue-400 font-semibold text-lg mb-2" }, `Pergunta ${questionNumber} de ${totalQuestions}`),
                        React.createElement(ProgressBar, { current: questionNumber, total: totalQuestions }),
                        React.createElement('h2', { className: "text-2xl md:text-3xl font-bold text-white" }, question.question)
                    ),
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                        question.options.map((option, index) =>
                            React.createElement('button', {
                                key: index,
                                onClick: () => onAnswerSelect(index),
                                className: `p-4 rounded-lg text-left text-lg transition-all duration-200 border-2 ${selectedAnswer === index ? 'bg-blue-500 border-blue-400 text-white font-semibold shadow-lg' : 'bg-gray-700 border-gray-600 hover:bg-gray-600 hover:border-gray-500'}`
                            }, option)
                        )
                    ),
                    React.createElement('div', { className: "mt-8 flex items-center justify-between" },
                        questionNumber > 1 ? React.createElement('button', { onClick: onPrevious, className: "bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-10 rounded-lg text-lg transition-all duration-200" }, "Anterior") : React.createElement('div'),
                        React.createElement('button', { onClick: onNext, disabled: selectedAnswer === null, className: "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-lg text-lg transition-all duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:opacity-50" }, isLastQuestion ? 'Ver Resultado' : 'Próxima Pergunta')
                    )
                )
            );
        };
        const TrophyIcon = () => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-20 w-20 text-yellow-400 mb-4", viewBox: "0 0 20 20", fill: "currentColor" },
              React.createElement('path', { fillRule: "evenodd", d: "M11.12 3.29a1 1 0 00-1.12.02L5.88 6.64a1 1 0 00-.5 1.5l1.65 2.85a1 1 0 001.6-.93L8.03 8.2a1.5 1.5 0 012.8-1.04l.95 1.64a1 1 0 001.6-.93l-1.65-2.85a1 1 0 00-1.6-.93l-.6 1.04z", clipRule: "evenodd" }),
              React.createElement('path', { d: "M12 11a1 1 0 011 1v1h1a1 1 0 110 2H6a1 1 0 110-2h1v-1a1 1 0 011-1h4z" }),
              React.createElement('path', { fillRule: "evenodd", d: "M3 6a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V6zm2-1a1 1 0 00-1 1v8a1 1 0 001 1h10a1 1 0 001-1V6a1 1 0 00-1-1H5z", clipRule: "evenodd" })
            )
        );
        const ResultsScreen = ({ score, totalQuestions, interpretation, onRestart }) => {
            const percentage = Math.round((score / totalQuestions) * 100);
            return React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen p-4 text-center" },
                React.createElement('div', { className: "bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-700" },
                    React.createElement(TrophyIcon),
                    React.createElement('h1', { className: "text-4xl md:text-5xl font-bold text-white mb-2" }, "Teste Concluído!"),
                    React.createElement('p', { className: "text-2xl text-gray-300 mb-4" }, "Sua pontuação final:"),
                    React.createElement('div', { className: "my-6" },
                        React.createElement('span', { className: "text-6xl font-bold text-blue-400" }, score),
                        React.createElement('span', { className: "text-3xl text-gray-400" }, ` / ${totalQuestions}`),
                        React.createElement('p', { className: "text-2xl font-semibold text-green-400 mt-2" }, `(${percentage}%)`)
                    ),
                    React.createElement('div', { className: "bg-gray-900/50 p-4 rounded-lg text-left mb-8" },
                        React.createElement('h3', { className: "text-xl font-semibold text-white mb-2" }, "Interpretação:"),
                        React.createElement('p', { className: "text-gray-300" }, interpretation ? interpretation : 'Calculando interpretação...')
                    ),
                    React.createElement('button', { onClick: onRestart, className: "w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-12 rounded-lg text-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50" }, "Tentar Novamente")
                )
            );
        };
        const LockIcon = () => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-16 w-16 mb-4 text-yellow-400", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" })
            )
        );
        const PaymentScreen = ({ onProceedToPayment }) => (
            React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen p-4 text-center" },
                React.createElement('div', { className: "bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-700" },
                    React.createElement(LockIcon),
                    React.createElement('h1', { className: "text-4xl md:text-5xl font-bold text-white mb-4" }, "Parabéns, você concluiu o teste!"),
                    React.createElement('p', { className: "text-lg text-gray-300 mb-8" }, "Você completou todas as perguntas. Sua pontuação está pronta para ser revelada. Para desbloquear sua análise de QI detalhada e ver sua pontuação final, pague uma taxa simbólica de manutenção e atualização do teste."),
                    React.createElement('button', { onClick: onProceedToPayment, className: "w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-12 rounded-lg text-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50" }, "VER RESULTADO")
                )
            )
        );
        const CreditCardIcon = () => (
            React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-16 w-16 mb-4 text-cyan-400", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: 2 },
                React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" })
            )
        );
        const PixPaymentScreen = ({ onPaymentConfirm }) => {
            const [password, setPassword] = useState('');
            const [showPasswordInput, setShowPasswordInput] = useState(false);
            const [error, setError] = useState(null);
            const handlePasswordChange = (e) => {
                const value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                if (value.length <= 4) { setPassword(value); if (error) setError(null); }
            };
            const handleGoToPaymentClick = () => { setShowPasswordInput(true); };
            const handleVerification = () => {
                if (password.length !== 4) { setError('A senha deve conter 4 caracteres.'); return; }
                onPaymentConfirm();
            };
            const isButtonDisabled = password.length < 4;

            return React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen p-4 text-center" },
                React.createElement('div', { className: "bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-700" },
                    React.createElement(CreditCardIcon),
                    React.createElement('h1', { className: "text-3xl md:text-4xl font-bold text-white mb-3" }, "Libere seu Resultado"),
                    React.createElement('p', { className: "text-lg text-gray-300 mb-6" }, "Para finalizar, clique no botão abaixo para ser redirecionado à página de pagamento seguro."),
                    React.createElement('a', { href: "https://mpago.la/1CT4sNZ", target: "_blank", rel: "noopener noreferrer", onClick: handleGoToPaymentClick, className: "inline-block w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-12 rounded-lg text-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50" }, "Ir para o Pagamento"),
                    showPasswordInput && React.createElement('div', { className: "w-full transition-opacity duration-500 ease-in-out opacity-100" },
                        React.createElement('div', { className: "w-full my-8 border-t border-gray-600" }),
                        React.createElement('div', { className: "w-full max-w-sm mx-auto" },
                            React.createElement('h2', { className: "text-2xl font-semibold text-white mb-2" }, "Senha de Acesso"),
                            React.createElement('p', { className: "text-gray-400 mb-4" }, "Insira os primeiros 4 dígitos do seu ID de transação que está no seu comprovante."),
                            React.createElement('input', { type: "text", value: password, onChange: handlePasswordChange, maxLength: 4, className: "w-full bg-gray-700 border-2 border-gray-600 rounded-lg text-white text-center text-3xl tracking-[0.5em] p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500", placeholder: "----", autoFocus: true }),
                            error && React.createElement('p', { className: "text-red-400 mt-2" }, error),
                            React.createElement('button', { onClick: handleVerification, disabled: isButtonDisabled, className: "mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-12 rounded-lg text-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:opacity-50" }, "Ver Resultado")
                        )
                    )
                )
            );
        };
        const RegistrationScreen = ({ onSubmit }) => {
            const [formData, setFormData] = useState({ fullName: '', motherName: '', age: '', gender: '' });
            const [error, setError] = useState(null);
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                if (Object.values(formData).some(val => typeof val === 'string' && val.trim() === '')) {
                    setError('Todos os campos são obrigatórios.'); return;
                }
                if (isNaN(Number(formData.age)) || Number(formData.age) <= 0) {
                    setError('Por favor, insira uma idade válida.'); return;
                }
                setError(null);
                onSubmit(formData);
            };
            const isFormValid = Object.values(formData).every(val => typeof val === 'string' && val.trim() !== '') && !isNaN(Number(formData.age)) && Number(formData.age) > 0;
            return React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen p-4" },
                React.createElement('div', { className: "bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700" },
                    React.createElement('h1', { className: "text-3xl font-bold text-white mb-2 text-center" }, "Informações do Candidato"),
                    React.createElement('p', { className: "text-gray-400 mb-6 text-center" }, "Por favor, preencha seus dados para continuar."),
                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement('div', null, React.createElement('label', { htmlFor: "fullName", className: "block text-sm font-medium text-gray-300 mb-1" }, "Nome Completo"), React.createElement('input', { type: "text", id: "fullName", name: "fullName", value: formData.fullName, onChange: handleChange, className: "w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500", required: true })),
                        React.createElement('div', null, React.createElement('label', { htmlFor: "motherName", className: "block text-sm font-medium text-gray-300 mb-1" }, "Nome da Mãe"), React.createElement('input', { type: "text", id: "motherName", name: "motherName", value: formData.motherName, onChange: handleChange, className: "w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500", required: true })),
                        React.createElement('div', { className: "flex space-x-4" },
                            React.createElement('div', { className: "w-1/2" }, React.createElement('label', { htmlFor: "age", className: "block text-sm font-medium text-gray-300 mb-1" }, "Idade"), React.createElement('input', { type: "number", id: "age", name: "age", value: formData.age, onChange: handleChange, className: "w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500", required: true })),
                            React.createElement('div', { className: "w-1/2" }, React.createElement('label', { htmlFor: "gender", className: "block text-sm font-medium text-gray-300 mb-1" }, "Gênero"), React.createElement('select', { id: "gender", name: "gender", value: formData.gender, onChange: handleChange, className: "w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500", required: true }, React.createElement('option', { value: "", disabled: true }, "Selecione..."), React.createElement('option', { value: "Masculino" }, "Masculino"), React.createElement('option', { value: "Feminino" }, "Feminino"), React.createElement('option', { value: "Outro" }, "Outro")))
                        ),
                        error && React.createElement('p', { className: "text-red-400 text-sm text-center" }, error),
                        React.createElement('button', { type: "submit", disabled: !isFormValid, className: "w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed" }, "Continuar para o Teste")
                    )
                )
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [gameState, setGameState] = useState(GameState.Loading);
            const [questions, setQuestions] = useState([]);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            const [score, setScore] = useState(0);
            const [interpretation, setInterpretation] = useState(null);
            const [error, setError] = useState(null);
            const [loadingMessage, setLoadingMessage] = useState('Gerando seu teste de QI...');
            const [userData, setUserData] = useState(null);

            const resetTestState = () => {
                setCurrentQuestionIndex(0);
                setUserAnswers(new Array(questions.length).fill(null));
                setScore(0);
                setInterpretation(null);
            };

            const loadTest = useCallback(async () => {
                setLoadingMessage('Gerando seu teste de QI...');
                setGameState(GameState.Loading);
                setError(null);
                setInterpretation(null);
                try {
                    const newQuestions = await generateIQTest();
                    setQuestions(newQuestions);
                    setUserAnswers(new Array(newQuestions.length).fill(null));
                    setGameState(GameState.Welcome);
                } catch (err) {
                    setError(err instanceof Error ? err.message : "Ocorreu um erro desconhecido.");
                    setGameState(GameState.Error);
                }
            }, []);

            useEffect(() => { loadTest(); }, [loadTest]);

            const handleStart = () => { setGameState(GameState.Registration); };
            const handleRegistrationSubmit = (data) => { setUserData(data); resetTestState(); setGameState(GameState.InProgress); };
            const handleAnswerSelect = (answerIndex) => {
                const newAnswers = [...userAnswers];
                newAnswers[currentQuestionIndex] = answerIndex;
                setUserAnswers(newAnswers);
            };

            const handlePaymentSuccess = useCallback(async (isNewPayment) => {
                try {
                    if (isNewPayment) {
                        const motherNameKey = userData?.motherName?.trim().toUpperCase();
                        if (motherNameKey) {
                            setLoadingMessage("Registrando pagamento...");
                            setGameState(GameState.Loading);
                            const paymentRecords = await readBin();
                            paymentRecords[motherNameKey] = { attemptsRemaining: 1 }; // 2 total uses, 1 consumed now, 1 remains
                            await updateBin(paymentRecords);
                        }
                    }
                    setLoadingMessage("Processando seu resultado...");
                    if (gameState !== GameState.Loading) setGameState(GameState.Loading);
                    
                    const interpretationText = await interpretScore(score, questions.length);
                    setInterpretation(interpretationText);
                    setGameState(GameState.Results);
                } catch (err) {
                    setError(err instanceof Error ? err.message : "Ocorreu um erro ao processar o pagamento.");
                    setGameState(GameState.Error);
                }
            }, [score, questions.length, userData, gameState]);

            const handleNext = async () => {
                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                } else {
                    const finalScore = userAnswers.reduce((acc, answer, i) => (answer === questions[i].correctAnswerIndex ? acc + 1 : acc), 0);
                    setScore(finalScore);

                    try {
                        setLoadingMessage("Verificando seu acesso...");
                        setGameState(GameState.Loading);

                        const motherNameKey = userData?.motherName?.trim().toUpperCase();
                        if (!motherNameKey) {
                            setGameState(GameState.Payment);
                            return;
                        }

                        const paymentRecords = await readBin();
                        const userRecord = paymentRecords[motherNameKey];

                        if (userRecord && userRecord.attemptsRemaining > 0) {
                            userRecord.attemptsRemaining -= 1;
                            await updateBin(paymentRecords);
                            await handlePaymentSuccess(false);
                        } else {
                            setGameState(GameState.Payment);
                        }
                    } catch (err) {
                        setError(err instanceof Error ? err.message : "Ocorreu um erro ao verificar o acesso.");
                        setGameState(GameState.Error);
                    }
                }
            };
            
            const handleProceedToPix = () => { setGameState(GameState.PixPayment); };
            const handlePrevious = () => { if (currentQuestionIndex > 0) setCurrentQuestionIndex(currentQuestionIndex - 1); };
            
            const handleRestart = async () => {
                try {
                    const motherNameKey = userData?.motherName?.trim().toUpperCase();
                    if (motherNameKey) {
                        setLoadingMessage("Verificando tentativas restantes...");
                        setGameState(GameState.Loading);
                        const paymentRecords = await readBin();
                        if (paymentRecords[motherNameKey]?.attemptsRemaining > 0) {
                            resetTestState();
                            setGameState(GameState.InProgress);
                            return;
                        }
                    }
                    setUserData(null);
                    await loadTest();
                } catch (err) {
                    setError(err instanceof Error ? err.message : "Ocorreu um erro ao reiniciar o teste.");
                    setGameState(GameState.Error);
                }
            };

            const renderContent = () => {
                switch (gameState) {
                    case GameState.Loading: return React.createElement(LoadingSpinner, { message: loadingMessage });
                    case GameState.Welcome: return React.createElement(WelcomeScreen, { onStart: handleStart });
                    case GameState.Registration: return React.createElement(RegistrationScreen, { onSubmit: handleRegistrationSubmit });
                    case GameState.InProgress: return React.createElement(QuestionCard, { question: questions[currentQuestionIndex], questionNumber: currentQuestionIndex + 1, totalQuestions: questions.length, selectedAnswer: userAnswers[currentQuestionIndex], onAnswerSelect: handleAnswerSelect, onNext: handleNext, onPrevious: handlePrevious });
                    case GameState.Payment: return React.createElement(PaymentScreen, { onProceedToPayment: handleProceedToPix });
                    case GameState.PixPayment: return React.createElement(PixPaymentScreen, { onPaymentConfirm: () => handlePaymentSuccess(true) });
                    case GameState.Results: return React.createElement(ResultsScreen, { score: score, totalQuestions: questions.length, interpretation: interpretation, onRestart: handleRestart });
                    case GameState.Error: return React.createElement('div', { className: "flex flex-col items-center justify-center min-h-screen p-4 text-center" }, React.createElement('div', { className: "bg-red-900/50 border border-red-700 p-8 rounded-lg max-w-md" }, React.createElement('h2', { className: "text-2xl font-bold text-red-300 mb-4" }, "Erro!"), React.createElement('p', { className: "text-red-200 mb-6" }, error), React.createElement('button', { onClick: loadTest, className: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg" }, "Tentar Novamente")));
                    default: return null;
                }
            };
            return React.createElement('div', { className: "bg-gray-900 min-h-screen" }, renderContent());
        };

        // --- App Entry Point ---
        const rootElement = document.getElementById('root');
        if (!rootElement) throw new Error("Could not find root element to mount to");
        const root = ReactDOM.createRoot(rootElement);
        root.render(React.createElement(App));
    }
  </script>
</body>
</html>